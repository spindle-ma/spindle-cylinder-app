<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spindle Cylinder System</title>

<!-- iOS Home Screen Support -->
<link rel="apple-touch-icon" sizes="180x180" href="/spindle-cylinder-app/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Spindle Cylinder Log">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  min-height: 100vh;
  background: #EAF3FB;
  font-family: Arial, sans-serif;
  color: #1E293B;
}

.center {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.box {
  background: #ffffff;
  padding: 30px;
  width: 520px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.header {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 10px;
}

.header img { width: 60px; }
h2 { margin: 0; }

label {
  margin-top: 14px;
  display: block;
  font-size: 14px;
  font-weight: 600;
}

.required {
  color: #dc2626;
  margin-left: 4px;
}

input, select, textarea, button {
  width: 100%;
  box-sizing: border-box;
}

input, select, textarea {
  padding: 10px;
  margin-top: 6px;
  border: 1px solid #CBD5E1;
  border-radius: 8px;
}

button {
  margin-top: 16px;
  padding: 12px;
  background: #0057B8;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
}

.secondary { background: #64748B; }
.danger { background: #DC2626; }

.message { margin-top: 12px; text-align: center; font-size: 13px; }
.error { color: #DC2626; }
.success { color: #16A34A; }

.fullscreen { padding: 20px 30px; }

.topbar {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}

.back-btn {
  width: auto;
  padding: 6px 12px;
  margin-top: 0;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 13px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #E2E8F0;
  vertical-align: middle;
  text-align: left;
}

th { color: #0057B8; }

.actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

.download-btn {
  background: #0F766E;
  color: white;
  font-size: 14px;
}

.edit-btn { background: #0057B8; color: white; }
.delete-btn { background: #DC2626; color: white; }

.result-count {
  font-size: 16px;
  font-weight: 600;
  color: #1E293B;
  margin-top: 6px;
  display: none;
}

.small-muted {
  font-size: 12px;
  color: #1E293B;
  line-height: 1.4;
}

td input,
td select,
td textarea {
  font-size: 13px;
  padding: 6px 8px;
  margin: 0;
  height: auto;
}

td textarea {
  resize: vertical;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
}

.modal-box {
  background: white;
  padding: 24px;
  border-radius: 14px;
  width: 340px;
  text-align: center;
}

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

/* ===== Toolbar Layout ===== */
.toolbar {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toolbar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.toolbar-row select,
.toolbar-row input[type="date"] {
  width: 160px;
}

.toolbar-row button {
  height: 38px;
  padding: 0 14px;
  font-size: 14px;
}

.icon-btn.ghost {
  background: transparent;
  border: 1px solid #CBD5E1;
  color: #1E293B;
  font-size: 16px;
}

.icon-btn.ghost:hover {
  background: #E2E8F0;
}

.full-row {
  grid-column: 1 / -1;
}

#pageView .toolbar button {
  width: auto;
  padding: 6px 10px;
  margin-top: 0;
  font-weight: normal;
}

#pageView .toolbar {
  max-width: 520px;
  justify-self: end;
}

</style>
</head>

<body>

<!-- SUBMIT PAGE -->
<div class="center" id="pageSubmit">
<div class="box">
<div class="header">
  <img src="logo.png">
  <h2>Spindle Cylinder Log</h2>
</div>

<label>Employee No <span class="required">*</span></label>
<input id="emp">

<label>Machine Type <span class="required">*</span></label>
<select id="machine"><option value="">Select machine</option></select>

<label>Cylinder ID (Auto)</label>
<input id="cylinder" readonly>

<label>Date <span class="required">*</span></label>
<input id="date" type="date">

<label>Remarks</label>
<textarea id="remarks"></textarea>

<div id="oringSection" style="display:none; margin-top:14px;">
  <label>FS 20K O-Ring Checklist</label>
  <div id="oringList"></div>
</div>

<button id="submitBtn">Submit</button>
<button class="secondary" id="viewBtn">View Submissions</button>
<div class="message" id="msg"></div>
</div>
</div>

<!-- VIEW PAGE -->
<div id="pageView" style="display:none;">
<div class="fullscreen">
<div class="topbar">
  <button class="secondary icon-btn back-btn" id="backBtn">‚Üê Back</button>

  <div class="title-block">
    <h2>Submissions</h2>
    <div id="resultCount" class="result-count"></div>
  </div>

  <div class="toolbar">
  <div class="toolbar-row">
    <select id="searchMachine">
      <option value="">All Machines</option>
    </select>

    <input type="date" id="fromDate">
    <input type="date" id="toDate">

    <button class="icon-btn ghost" id="searchBtn" title="Search">üîç</button>
    <button class="icon-btn ghost" id="clearSearchBtn" title="Clear">Clear Search</button>
    <button class="icon-btn ghost" id="downloadBtn" title="Download">‚¨á</button>
  </div>

  <div class="toolbar-row">
    <button class="secondary full-row" id="leaderBtn">Leader Login</button>
    <button class="secondary full-row" id="logoutBtn" style="display:none;">
      Logout
    </button>
  </div>
</div>

</div>
<div id="tableWrap"></div>
</div>
</div>

<!-- LEADER LOGIN -->
<div class="modal" id="leaderModal">
<div class="modal-box">
<h3>Leader Login</h3>
<input id="leaderUser" placeholder="Username">
<input id="leaderPass" type="password" placeholder="Password">
<button id="leaderLogin">Login</button>
<button class="secondary" id="leaderCancel">Cancel</button>
<div class="message error" id="leaderMsg"></div>
</div>
</div>

<!-- DELETE CONFIRM -->
<div class="modal" id="deleteModal">
<div class="modal-box">
<h3>Confirm Deletion</h3>
<p>This action cannot be undone.</p>
<div class="modal-actions">
<button class="danger" id="confirmDelete">Delete</button>
<button class="secondary" id="cancelDelete">Cancel</button>
</div>
</div>
</div>

<!-- DOWNLOAD MODAL -->
<div class="modal" id="downloadModal">
  <div class="modal-box">
    <h3>Confirm Download</h3>
    <p>Download the filtered submissions?</p>
    <div class="modal-actions">
      <button class="edit-btn" id="confirmDownload">Download</button>
      <button class="secondary" id="cancelDownload">Cancel</button>
    </div>
  </div>
</div>

<!-- O-RING EDIT MODAL -->
<div class="modal" id="oringModal">
  <div class="modal-box" style="width:420px;text-align:left;">
    <h3>Edit FS20K O-Rings</h3>
    <div id="oringEditList"></div>
    <div class="modal-actions">
      <button class="edit-btn" onclick="saveOrings()">Save</button>
      <button class="secondary" onclick="closeOringModal()">Cancel</button>
    </div>
  </div>
</div>
<div class="modal" id="oringViewModal">
  <div class="modal-box" id="oringViewBox"></div>
</div>

<script>
const client = supabase.createClient(
  "https://ttvwmcmpvqmooforotqu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0dndtY21wdnFtb29mb3JvdHF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDkxNTUsImV4cCI6MjA4MDcyNTE1NX0.pJumMflIvlnHZ_HDF5gLojd0-zbV-Yfoiw3ejJSBkdA"
);

let isLeader = false;
let editingRow = null;
let deleteId = null;
let currentLeader = null;
let editingOringRow = null;

const FS20K_ORINGS = [
  ["Z261A3109501", "O-Ring B2401-P95", 2],
  ["Z269A0706501", "Back Up Ring Sun2b-P85", 1],
  ["Z261A8108501", "O-Ring P85", 1],
  ["Z269A0708501", "Back Up Ring Sun2b-P85", 1],
  ["Z261N4568157", "O-Ring AS568-157", 1],
  ["13F011A2016", "Spring", 4],
  ["Z461T2212106", "Straight, PCF 12-03", 1],
  ["4V11A743", "Gasket", 1]
];

date.value = new Date().toISOString().split("T")[0];

// Load machines
(async () => {
  const { data } = await client.from("Machine Types").select("id,name");
  data.forEach(m => {
  machine.innerHTML += `<option value="${m.id}">${m.name}</option>`;
  searchMachine.innerHTML += `<option value="${m.id}">${m.name}</option>`;
});

})();

// Auto cylinder preview (submit page)
machine.onchange = async () => {
  cylinder.value = "";
  if (!machine.value) return;

  const machineName = machine.options[machine.selectedIndex].text;

  if (machineName === "FS 20K") {
    oringSection.style.display = "block";
    renderOrings();
  } else {
    oringSection.style.display = "none";
  }

  const { data } = await client.rpc("next_cylinder_preview", { mt_id: Number(machine.value) });
  cylinder.value = data;
};

// Submit (UNCHANGED)
submitBtn.onclick = async () => {
  msg.textContent = "";
  if (!emp.value) return showErr("* Employee No is required");
  if (!/^\d+$/.test(emp.value)) return showErr("* Employee No must be numeric");
  if (!machine.value) return showErr("* Machine type is required");

let oringData = null;

if (oringSection.style.display === "block") {
  oringData = {};
  FS20K_ORINGS.forEach((_, i) => {
    const chk = document.getElementById("oring_chk_" + i);
    const rem = document.getElementById("oring_rem_" + i);

    oringData[i] = {
      checked: chk ? chk.checked : false,
      remarks: rem ? rem.value.trim() : ""
    };
  });
}

  const { error } = await client.from("Submissions").insert({
    "Emp No": emp.value,
    "Cylinder ID": cylinder.value,
    machine_type_id: Number(machine.value),
    Remarks: remarks.value,
    created_at: date.value,
    o_ring_fs20k: oringData
  });

  if (error) return showErr("Submission failed");

  msg.textContent = "Submitted successfully";
  msg.className = "message success";

  emp.value = machine.value = cylinder.value = remarks.value = "";
  oringSection.style.display = "none";
  renderOrings({});
};

// Navigation
viewBtn.onclick = loadView;
backBtn.onclick = () => {
  pageView.style.display = "none";
  pageSubmit.style.display = "flex";
};

// Leader modal
leaderBtn.onclick = () => leaderModal.style.display = "flex";
leaderCancel.onclick = () => leaderModal.style.display = "none";

// Leader login
leaderLogin.onclick = async () => {
  const { data } = await client.rpc("leader_login", {
    u: leaderUser.value,
    p: leaderPass.value
  });

  if (!data) {
    leaderMsg.textContent = "Invalid credentials";
    return;
  }

  isLeader = true;
  currentLeader = leaderUser.value;
  leaderModal.style.display = "none";
  leaderBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";
  loadView();
};

// Logout
logoutBtn.onclick = () => {
  isLeader = false;
  currentLeader = null;
  editingRow = null;
  leaderBtn.style.display = "inline-block";
  logoutBtn.style.display = "none";
  loadView();
};

// Load table
async function loadView() {
  pageSubmit.style.display = "none";
  pageView.style.display = "block";

let query = client.from("Submissions")
  .select(`id,created_at,"Emp No","Cylinder ID",Remarks,edited_by,edited_at,o_ring_fs20k,machine_type_id,"Machine Types"(name)`)
  .order("created_at",{ascending:false});

if (fromDate.value) query = query.gte("created_at", fromDate.value);
if (toDate.value) query = query.lte("created_at", toDate.value);
if (searchMachine.value) query = query.eq("machine_type_id", Number(searchMachine.value));

const { data } = await query;
const countBox = document.getElementById("resultCount");

if (fromDate.value || toDate.value || searchMachine.value) {
  countBox.style.display = "block";

  if (!data || data.length === 0) {
    countBox.innerHTML = "<span style='color:#DC2626'>No results found</span>";
  } else {
    countBox.textContent = `${data.length} result(s) found`;
  }
} else {
  countBox.style.display = "none";
}

  window.lastData = data;

  let html = `<table><tr>
    <th>Date</th><th>Emp</th><th>Machine</th><th>Cylinder</th><th>Remarks</th><th>O-Ring</th><th>Last Edited</th>
    ${isLeader ? "<th>Actions</th>" : ""}
  </tr>`;

  data.forEach(r => {
    const edit = editingRow === r.id;
        let tickedCount = 0;
    if (r.o_ring_fs20k) {
      Object.values(r.o_ring_fs20k).forEach(v => {
        if (v.checked) tickedCount++;
      });
    }
    html += `<tr>
      <td>${r.created_at.split("T")[0]}</td>
      <td>${edit ? `<input id="emp${r.id}" value="${r["Emp No"]}">` : r["Emp No"]}</td>
      <td>${edit ? machineSelect(r.id, r.machine_type_id) : r["Machine Types"].name}</td>
      <td>${edit ? `<input id="cyl${r.id}" value="${r["Cylinder ID"]}">` : r["Cylinder ID"]}</td>
      <td>${edit ? `<textarea id="rem${r.id}">${r.Remarks||""}</textarea>` : r.Remarks||""}</td>
     <td class="small-muted">
  ${r.o_ring_fs20k
    ? `
      <a href="javascript:void(0)" onclick="showOrings(${r.id})">
        ${tickedCount}/${FS20K_ORINGS.length} O-rings
      </a>
      ${isLeader
        ? `<br><a href="javascript:void(0)" onclick="editOrings(${r.id})">Edit</a>`
        : ""
      }
    `
    : "-"
  }
</td>

      <td class="small-muted">${r.edited_by ? `${r.edited_by}<br>${new Date(r.edited_at).toLocaleString()}` : "-"}</td>
     ${isLeader ? `
     <td class="actions">
  ${edit
    ? `<button class="icon-btn edit-btn" onclick="saveRow(${r.id})">Save</button>
       <button class="icon-btn secondary" onclick="cancelEdit()">Cancel</button>`
    : `<button class="icon-btn edit-btn" onclick="editRow(${r.id})">‚úèÔ∏è</button>`}
  <button class="icon-btn delete-btn" onclick="askDelete(${r.id})">üóëÔ∏è</button>
</td>` : ""}

    </tr>`;
  });

  tableWrap.innerHTML = html + "</table>";
}

function machineSelect(id, selected) {
  let html = `<select id="mach${id}" onchange="regenerateCylinder(${id})">`;
  document.querySelectorAll("#machine option").forEach(o => {
    html += `<option value="${o.value}" ${o.value==selected?"selected":""}>${o.text}</option>`;
  });
  return html + `</select>`;
}

function editRow(id) {
  editingRow = id;
  loadView();
}

function cancelEdit() {
  editingRow = null;
  loadView();
}

async function saveRow(id) {
  const { error } = await client.from("Submissions").update({
    "Emp No": document.getElementById("emp"+id).value,
    machine_type_id: Number(document.getElementById("mach"+id).value),
    "Cylinder ID": document.getElementById("cyl"+id).value,
    Remarks: document.getElementById("rem"+id).value,
    edited_by: currentLeader,
    edited_at: new Date().toISOString()
  }).eq("id", id);

  if (error) {
    alert(error.message);
    return;
  }

  editingRow = null;
  loadView();
}

// Delete
function askDelete(id) {
  deleteId = id;
  deleteModal.style.display = "flex";
}
cancelDelete.onclick = () => deleteModal.style.display = "none";
confirmDelete.onclick = async () => {
  await client.from("Submissions").delete().eq("id",deleteId);
  deleteModal.style.display = "none";
  loadView();
};

function showErr(t) {
  msg.textContent = t;
  msg.className = "message error";
}

async function regenerateCylinder(id) {
  const machSelect = document.getElementById("mach" + id);
  const cylInput = document.getElementById("cyl" + id);

  if (!machSelect || !cylInput || !machSelect.value) return;

  const { data, error } = await client.rpc("next_cylinder_preview", {
    mt_id: Number(machSelect.value)
  });

  if (!error && data) {
    cylInput.value = data;
  }
}

function renderOrings(saved = {}) {
  oringList.innerHTML = "";
  FS20K_ORINGS.forEach((o, i) => {
    oringList.innerHTML += `
      <div style="
      display:grid;
      grid-template-columns:20px 2fr 40px 2fr;
      gap:8px;
      align-items:center;
      font-size:12px;
      margin-bottom:6px;
      ">
        <input type="checkbox" id="oring_chk_${i}" ${saved[i]?.checked ? "checked" : ""}>
        <div>${o[0]} ‚Äì ${o[1]}</div>
        <div>${o[2]}</div>
        <input id="oring_rem_${i}" value="${saved[i]?.remarks || ""}">
      </div>
    `;
  });
}

function showOrings(id) {
  const row = window.lastData.find(r => r.id === id);
  if (!row || !row.o_ring_fs20k) return;

  let html = `<h3>FS20K O-Ring Details</h3>`;

  FS20K_ORINGS.forEach((o, i) => {
    const d = row.o_ring_fs20k[i];
    if (!d) return;

    // SHOW if checked OR remarks exist
    if (d.checked || d.remarks) {
      html += `
        <div style="font-size:12px;margin-bottom:8px;text-align:left;">
          ${d.checked ? "‚úî" : "‚úñ"} ${o[0]} ‚Äì ${o[1]} (Qty ${o[2]})<br>
          <span style="color:#64748B;">
            ${d.remarks || "No remarks"}
          </span>
        </div>
      `;
    }
  });

  html += `<button class="secondary" onclick="closeOringView()">Close</button>`;

  oringViewBox.innerHTML = html;
  oringViewModal.style.display = "flex";

}

function editOrings(id) {
 oringViewModal.style.display = "none";
  const row = window.lastData.find(r => r.id === id);
  if (!row || !row.o_ring_fs20k) return;

  editingOringRow = id;
  oringEditList.innerHTML = "";

  FS20K_ORINGS.forEach((o, i) => {
    const d = row.o_ring_fs20k[i] || {};
    oringEditList.innerHTML += `
      <div style="
        display:grid;
        grid-template-columns:20px 2fr 40px 2fr;
        gap:8px;
        align-items:center;
        font-size:12px;
        margin-bottom:6px;">
        <input type="checkbox" id="edit_chk_${i}" ${d.checked ? "checked" : ""}>
        <div>${o[0]} ‚Äì ${o[1]}</div>
        <div>${o[2]}</div>
        <input id="edit_rem_${i}" value="${d.remarks || ""}">
      </div>
    `;
  });

  oringModal.style.display = "flex";
}

function closeOringModal() {
  editingOringRow = null;
  oringModal.style.display = "none";
}

function closeOringView() {
  oringViewModal.style.display = "none";
}

async function saveOrings() {
  if (!editingOringRow) return;

  let updated = {};
  FS20K_ORINGS.forEach((_, i) => {
    updated[i] = {
      checked: document.getElementById("edit_chk_" + i).checked,
      remarks: document.getElementById("edit_rem_" + i).value.trim()
    };
  });

  const { error } = await client.from("Submissions").update({
    o_ring_fs20k: updated,
    edited_by: currentLeader,
    edited_at: new Date().toISOString()
  }).eq("id", editingOringRow);

  if (error) {
    alert(error.message);
    return;
  }

  closeOringModal();
  loadView();
}

// DOWNLOAD BUTTON
searchBtn.onclick = () => {
  loadView();
};

clearSearchBtn.onclick = () => {
  searchMachine.value = "";
  fromDate.value = "";
  toDate.value = "";
  loadView();
};

downloadBtn.onclick = () => {
  downloadModal.style.display = "flex";
};

cancelDownload.onclick = () => {
  downloadModal.style.display = "none";
};

confirmDownload.onclick = async () => {
  downloadModal.style.display = "none";
  await performDownload();
};
async function performDownload() {
  const from = fromDate.value;
  const to = toDate.value;

  let query = client
    .from("Submissions")
    .select(`created_at,"Emp No","Cylinder ID",Remarks,o_ring_fs20k,"Machine Types"(name)`)
    .order("created_at", { ascending: true });

  if (from) query = query.gte("created_at", from);
  if (to) query = query.lte("created_at", to);
  if (searchMachine.value)
    query = query.eq("machine_type_id", Number(searchMachine.value));

  const { data, error } = await query;
  if (error || !data.length) {
  downloadModal.style.display = "flex";
  document.querySelector("#downloadModal p").textContent =
    "No data found for the selected filters.";
  return;
}

let csv = "Date,Employee,Machine,Cylinder,Remarks,O-Rings Details\n";

  data.forEach(r => {
  let details = [];

  if (r.o_ring_fs20k) {
    FS20K_ORINGS.forEach((o, i) => {
      const d = r.o_ring_fs20k[i];
      if (d?.checked || d?.remarks) {
        details.push(`${o[0]} (${d.checked ? "‚úî" : "‚úñ"}): ${d.remarks || "OK"}`);
      }
    });
  }

  csv += `"${r.created_at.split("T")[0]}","${r["Emp No"]}","${r["Machine Types"].name}","${r["Cylinder ID"]}","${(r.Remarks||"").replace(/"/g,'""')}","${details.join(" | ").replace(/"/g,'""')}"\n`;
});

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "spindle_submissions.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

</script>
</body>
</html>
